<!doctype html>
<html lang="en">

<head>
   <meta charset="utf-8">
   <title>Interactive Top Hat</title>
   <style>
      canvas {
         display: block;
         margin: 10px;
         width: 800px;
         height: 500px
      }
   </style>

   <script src="./js/three.js"> </script>
   <script src="./js/SceneUtils.js"></script>
   <script src="./js/OrbitControls.js"></script>
   <script src="./js/tw.js"></script>
   <script src="./js/dat.gui.js"></script>

</head>

<body>
   <h2>Interactive Top Hat</h2>
   <h4>Hold down the <code>shift</code> key while clicking on an object in the scene to put on cat's head, do the same to return to shelf</h4>
   <script id="interactiveTopHat">
      var scene = new THREE.Scene();

      var renderer = new THREE.WebGLRenderer();

      TW.mainInit(renderer, scene);

      // add three houses (solid color barns) to the scene
      var params = {
            headRadius: 3,
            hatHeight: 3, 
            bottomHatRadius: 2.7,
            hatRadius: 2,
            hatRotation: 0,
            zPlaneRotation: 0,
            xPlaneRotation:0,
            hatSeg: 1,
            yHeadPosition: 9,
            onCat: false
        };

        // colors and materials for the top hat
        var headMaterial = new THREE.MeshBasicMaterial({ color: 0xD08050 });
        var blackMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });
        var goldMaterial = new THREE.MeshBasicMaterial({ color: 0xFFD700});

        function createHat(texture){
            // create and return a Mesh for the hat
            var height = params.hatHeight;
            var radius = params.hatRadius;
            var hatGeometry = new THREE.CylinderGeometry(radius, radius, height, 40, params.hatSeg);
            var silkMaterial = new THREE.MeshBasicMaterial({ color: "0xFFD700", map: texture});
            var hatMesh = new THREE.Mesh(hatGeometry, silkMaterial);
            return hatMesh;
        }
        function createBottomHat(texture){
            // create and return a Mesh for the bottom of the hat
            var radius = params.bottomHatRadius;
            var hatGeometry = new THREE.CylinderGeometry(radius, radius, 0.45, 40, params.hatSeg);
            var silkMaterial = new THREE.MeshBasicMaterial({ color: "0xFFD700", map: texture});
            var hatMesh = new THREE.Mesh(hatGeometry, silkMaterial);
            return hatMesh;
        }

        function createDesignHat(texture){
            // create and return a Mesh for the design of the hat
            var radius = params.hatRadius;
            var hatGeometry = new THREE.CylinderGeometry(radius + 0.1, radius + 0.1, 0.7, 40, params.hatSeg);
            var silkMaterial = new THREE.MeshBasicMaterial({ color: "0xFFD700", map: texture});
            var hatMesh = new THREE.Mesh(hatGeometry, silkMaterial);
            return hatMesh;
        }
        var hatframe;
        function addHat(texture){
            // adds all components of hat together
            hatframe = new THREE.Object3D();
            var hat = createHat(texture[0]);
            var bottomHat = createBottomHat(texture[0]);
            var design = createDesignHat(texture[1]);
            hatframe.add(hat);
            hatframe.add(bottomHat);
            hatframe.add(design)
            // calculate position for the center of the head
            hat.position.y = 3.8;
            hat.position.x = 0;
            bottomHat.position.y = 2.3;
            bottomHat.position.x = 0;
            design.position.y = 2.7;
            design.position.x = 0;
            hat.rotation.y = params.hatRotation;
            bottomHat.rotation.y = params.hatRotation;
            scene.add(hatframe);
           // TW.render();
           renderer.render(scene, camera);
        }

        TW.loadTextures(["silk.jpeg", "yellowsilk.jpeg"],
            function (texture) {
                addHat(texture);
            } );

      // camera for scene
      var camera = new THREE.PerspectiveCamera(70, 800 / 500, 1, 1000);
      camera.position.set(0, 2, 20);
      camera.up.set(0, 1, 0);
      camera.lookAt(new THREE.Vector3(0, 0, 0));
      scene.add(camera);

      // eventListener for interactive hat
      document.addEventListener('mousedown', onClick, false);

      // set up raycasting
      var raycaster = new THREE.Raycaster();
      var mouse = new THREE.Vector2();
      var c1 = renderer.domElement;

      function onClick(event) {
         if (!event.shiftKey) return;    
         if (event.target == c1) {
            var rect = event.target.getBoundingClientRect();
            var canvasX = event.clientX - rect.left;
            var canvasY = event.clientY - rect.top;
         } else {
            return;
         }
         // get mouse coordinates in the range from -1 to +1 (canvas is 800 x 500 pixels)
         mouse.x = (canvasX / 800) * 2 - 1;
         mouse.y = -(canvasY / 500) * 2 + 1;
         raycaster.setFromCamera(mouse, camera);
         var intersects = raycaster.intersectObjects(scene.children, true);
         // if hat on cat, return to shelf
         if (intersects.length > 0) {
            intersects[0].object.material.color.set(gold);
            scene.remove(hatframe);
            if(params.onCat){
               hatframe.position.x = 10;   
                params.onCat = false
            }
            else{
                hatframe.position.x = -10; 
                params.onCat = true;
            }
            scene.add(hatframe)
            console.log("mousedown");
            renderer.render(scene, camera);
         }
      }

      renderer.render(scene, camera);

   </script>
</body>

</html>